<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Docker RAG åŠ©æ‰‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #chat-box {
      height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background-color: #e3f2fd;
      margin-left: auto;
      text-align: right;
    }
    .ai {
      background-color: #f1f8e9;
      margin-right: auto;
    }
    #input-area {
      display: flex;
      gap: 10px;
    }
    #question-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover:not(:disabled) {
      background-color: #1565c0;
    }
    button:disabled {
      background-color: #bdbdbd;
      cursor: not-allowed;
    }
    .loading {
      color: #999;
    }
  </style>
</head>
<body>
  <h1>ğŸ³ Docker æŠ€æœ¯é—®ç­”åŠ©æ‰‹</h1>
  <div id="chat-box"></div>
  <div id="input-area">
    <input type="text" id="question-input" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šDockeré•œåƒå¦‚ä½•æ„å»ºï¼Ÿ" />
    <button id="send-btn">å‘é€</button>
  </div>

  <script>
    // ==============================
    // é…ç½®
    // ==============================
    const API_URL = 'http://localhost:8000/ask';
    
    // ç”Ÿæˆå”¯ä¸€ session_idï¼ˆåˆ·æ–°é¡µé¢ä¼šé‡ç½®ï¼Œä½†ä¸€æ¬¡ä¼šè¯å†…ä¿æŒä¸€è‡´ï¼‰
    let sessionId = localStorage.getItem('sessionId') || 
                   'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('sessionId', sessionId);

    const chatBox = document.getElementById('chat-box');
    const inputEl = document.getElementById('question-input');
    const sendBtn = document.getElementById('send-btn');

    // ==============================
    // å·¥å…·å‡½æ•°
    // ==============================
    function addMessage(text, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}`;
      msgDiv.textContent = text;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    }

    async function sendMessage() {
      const question = inputEl.value.trim();
      if (!question) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(question, 'user');
      inputEl.value = '';
      sendBtn.disabled = true;

      try {
        // æ˜¾ç¤ºâ€œæ€è€ƒä¸­...â€
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai loading';
        loadingDiv.textContent = 'ğŸ¤” æ€è€ƒä¸­...';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        // è°ƒç”¨ API
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, session_id: sessionId })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();

        // ç§»é™¤ loading
        chatBox.removeChild(loadingDiv);

        // æ·»åŠ  AI å›ç­”
        addMessage(data.answer, 'ai');
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        alert('è¯·æ±‚å‡ºé”™ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      } finally {
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    // ==============================
    // äº‹ä»¶ç»‘å®š
    // ==============================
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // åˆå§‹æç¤º
    addMessage('ä½ å¥½ï¼æˆ‘æ˜¯ Docker æŠ€æœ¯åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”å…³äºé•œåƒã€å®¹å™¨ã€ç½‘ç»œç­‰é—®é¢˜ã€‚', 'ai');
  </script>
</body>
</html>